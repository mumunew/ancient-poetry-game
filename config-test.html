<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase é…ç½®æµ‹è¯• - å¤è¯—è¯æ¸¸æˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .content {
            padding: 40px;
        }

        .test-section {
            margin-bottom: 30px;
            padding: 25px;
            border: 2px solid #f0f0f0;
            border-radius: 15px;
        }

        .test-title {
            font-size: 1.3em;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .status {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            margin-left: 10px;
        }

        .status.pending {
            background: #ffeaa7;
            color: #d63031;
        }

        .status.success {
            background: #00b894;
            color: white;
        }

        .status.error {
            background: #e17055;
            color: white;
        }

        .test-result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            white-space: pre-wrap;
        }

        .result-success {
            background: #d4edda;
            border: 2px solid #c3e6cb;
            color: #155724;
        }

        .result-error {
            background: #f8d7da;
            border: 2px solid #f5c6cb;
            color: #721c24;
        }

        .result-info {
            background: #d1ecf1;
            border: 2px solid #bee5eb;
            color: #0c5460;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }

        .test-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
        }

        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§ª é…ç½®æµ‹è¯•</h1>
            <p>éªŒè¯ Supabase é…ç½®æ˜¯å¦æ­£ç¡®</p>
        </div>

        <div class="content">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <div class="test-section">
                <div class="test-title">
                    ğŸ“ é…ç½®æ–‡ä»¶æ£€æŸ¥
                    <span class="status pending" id="configStatus">ç­‰å¾…æµ‹è¯•</span>
                </div>
                <div class="test-result result-info" id="configResult">ç‚¹å‡»"å¼€å§‹æµ‹è¯•"æŒ‰é’®å¼€å§‹æ£€æŸ¥é…ç½®æ–‡ä»¶...</div>
            </div>

            <div class="test-section">
                <div class="test-title">
                    ğŸ”— æ•°æ®åº“è¿æ¥æµ‹è¯•
                    <span class="status pending" id="connectionStatus">ç­‰å¾…æµ‹è¯•</span>
                </div>
                <div class="test-result result-info" id="connectionResult">ç­‰å¾…é…ç½®æ–‡ä»¶æ£€æŸ¥å®Œæˆ...</div>
            </div>

            <div class="test-section">
                <div class="test-title">
                    ğŸ“Š æ•°æ®è¡¨ç»“æ„éªŒè¯
                    <span class="status pending" id="tableStatus">ç­‰å¾…æµ‹è¯•</span>
                </div>
                <div class="test-result result-info" id="tableResult">ç­‰å¾…æ•°æ®åº“è¿æ¥æµ‹è¯•å®Œæˆ...</div>
            </div>

            <div class="test-section">
                <div class="test-title">
                    âœï¸ æ•°æ®æ’å…¥æµ‹è¯•
                    <span class="status pending" id="insertStatus">ç­‰å¾…æµ‹è¯•</span>
                </div>
                <div class="test-result result-info" id="insertResult">ç­‰å¾…æ•°æ®è¡¨ç»“æ„éªŒè¯å®Œæˆ...</div>
                
                <div class="test-form" id="testForm" style="display: none;">
                    <h4>æµ‹è¯•æ•°æ®è¡¨å•</h4>
                    <div class="form-group">
                        <label for="testPlayerName">ç©å®¶åç§°</label>
                        <input type="text" id="testPlayerName" value="æµ‹è¯•ç”¨æˆ·" placeholder="è¾“å…¥æµ‹è¯•ç”¨æˆ·å">
                    </div>
                    <div class="form-group">
                        <label for="testSuggestions">åé¦ˆå»ºè®®</label>
                        <textarea id="testSuggestions" rows="3" placeholder="è¾“å…¥æµ‹è¯•åé¦ˆå†…å®¹">è¿™æ˜¯ä¸€ä¸ªé…ç½®æµ‹è¯•åé¦ˆï¼Œç”¨äºéªŒè¯æ•°æ®åº“è¿æ¥æ˜¯å¦æ­£å¸¸ã€‚</textarea>
                    </div>
                    <div class="form-group">
                        <label for="testScore">æ¸¸æˆå¾—åˆ†</label>
                        <input type="number" id="testScore" value="100" min="0" max="1000">
                    </div>
                    <button class="btn" onclick="testDataInsert()">ğŸš€ æµ‹è¯•æ•°æ®æ’å…¥</button>
                </div>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="btn" id="startTestBtn" onclick="startTest()">ğŸ§ª å¼€å§‹æµ‹è¯•</button>
                <button class="btn" onclick="resetTest()" style="background: #6c757d;">ğŸ”„ é‡ç½®æµ‹è¯•</button>
            </div>

            <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                <h3>ğŸ“‹ æµ‹è¯•è¯´æ˜</h3>
                <ul style="margin: 15px 0; padding-left: 20px; line-height: 1.6;">
                    <li><strong>é…ç½®æ–‡ä»¶æ£€æŸ¥</strong>ï¼šéªŒè¯ config.js æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”é…ç½®æ­£ç¡®</li>
                    <li><strong>æ•°æ®åº“è¿æ¥æµ‹è¯•</strong>ï¼šæµ‹è¯•ä¸ Supabase çš„ç½‘ç»œè¿æ¥</li>
                    <li><strong>æ•°æ®è¡¨ç»“æ„éªŒè¯</strong>ï¼šæ£€æŸ¥ game_feedback è¡¨æ˜¯å¦æ­£ç¡®åˆ›å»º</li>
                    <li><strong>æ•°æ®æ’å…¥æµ‹è¯•</strong>ï¼šå°è¯•æ’å…¥æµ‹è¯•æ•°æ®éªŒè¯å®Œæ•´åŠŸèƒ½</li>
                </ul>
            </div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        let supabase = null;
        let testProgress = 0;
        const totalTests = 4;

        function updateProgress() {
            testProgress++;
            const percentage = (testProgress / totalTests) * 100;
            document.getElementById('progressFill').style.width = percentage + '%';
        }

        function setStatus(elementId, status, text) {
            const element = document.getElementById(elementId);
            element.className = `status ${status}`;
            element.textContent = text;
        }

        function setResult(elementId, type, message) {
            const element = document.getElementById(elementId);
            element.className = `test-result result-${type}`;
            element.textContent = message;
        }

        async function startTest() {
            document.getElementById('startTestBtn').disabled = true;
            testProgress = 0;
            document.getElementById('progressFill').style.width = '0%';
            
            await testConfig();
            await testConnection();
            await testTableStructure();
            await prepareInsertTest();
            
            document.getElementById('startTestBtn').disabled = false;
        }

        async function testConfig() {
            setStatus('configStatus', 'pending', 'æ£€æŸ¥ä¸­...');
            setResult('configResult', 'info', 'æ­£åœ¨æ£€æŸ¥é…ç½®æ–‡ä»¶...');

            try {
                // æ£€æŸ¥é…ç½®æ˜¯å¦å­˜åœ¨
                if (typeof SUPABASE_CONFIG === 'undefined') {
                    throw new Error('æœªæ‰¾åˆ° SUPABASE_CONFIG é…ç½®å¯¹è±¡');
                }

                if (!SUPABASE_CONFIG.url) {
                    throw new Error('ç¼ºå°‘ Supabase URL é…ç½®');
                }

                if (!SUPABASE_CONFIG.anonKey) {
                    throw new Error('ç¼ºå°‘ Supabase åŒ¿åå¯†é’¥é…ç½®');
                }

                // éªŒè¯ URL æ ¼å¼
                const urlPattern = /^https:\/\/[a-zA-Z0-9-]+\.supabase\.co$/;
                if (!urlPattern.test(SUPABASE_CONFIG.url)) {
                    throw new Error('Supabase URL æ ¼å¼ä¸æ­£ç¡®');
                }

                // éªŒè¯å¯†é’¥æ ¼å¼
                if (!SUPABASE_CONFIG.anonKey.startsWith('eyJ')) {
                    throw new Error('åŒ¿åå¯†é’¥æ ¼å¼ä¸æ­£ç¡®');
                }

                setStatus('configStatus', 'success', 'âœ… é€šè¿‡');
                setResult('configResult', 'success', 
                    `é…ç½®æ–‡ä»¶æ£€æŸ¥é€šè¿‡ï¼\n` +
                    `- URL: ${SUPABASE_CONFIG.url}\n` +
                    `- åŒ¿åå¯†é’¥: ${SUPABASE_CONFIG.anonKey.substring(0, 20)}...\n` +
                    `- åé¦ˆè¡¨: ${SUPABASE_CONFIG.feedbackTable || 'game_feedback'}`
                );

            } catch (error) {
                setStatus('configStatus', 'error', 'âŒ å¤±è´¥');
                setResult('configResult', 'error', 
                    `é…ç½®æ–‡ä»¶æ£€æŸ¥å¤±è´¥ï¼š\n${error.message}\n\n` +
                    `è¯·ç¡®ä¿ï¼š\n` +
                    `1. js/config.js æ–‡ä»¶å­˜åœ¨\n` +
                    `2. é…ç½®äº†æ­£ç¡®çš„ SUPABASE_CONFIG å¯¹è±¡\n` +
                    `3. URL å’Œ anonKey æ ¼å¼æ­£ç¡®`
                );
            }

            updateProgress();
        }

        async function testConnection() {
            if (document.getElementById('configStatus').textContent !== 'âœ… é€šè¿‡') {
                setResult('connectionResult', 'error', 'è·³è¿‡æµ‹è¯•ï¼šé…ç½®æ–‡ä»¶æ£€æŸ¥æœªé€šè¿‡');
                updateProgress();
                return;
            }

            setStatus('connectionStatus', 'pending', 'è¿æ¥ä¸­...');
            setResult('connectionResult', 'info', 'æ­£åœ¨æµ‹è¯•æ•°æ®åº“è¿æ¥...');

            try {
                // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
                supabase = window.supabase.createClient(
                    SUPABASE_CONFIG.url,
                    SUPABASE_CONFIG.anonKey
                );

                // æµ‹è¯•è¿æ¥
                const { data, error } = await supabase
                    .from('game_feedback')
                    .select('count', { count: 'exact', head: true });

                if (error) {
                    throw error;
                }

                setStatus('connectionStatus', 'success', 'âœ… é€šè¿‡');
                setResult('connectionResult', 'success', 
                    `æ•°æ®åº“è¿æ¥æˆåŠŸï¼\n` +
                    `- è¿æ¥çŠ¶æ€: æ­£å¸¸\n` +
                    `- å“åº”æ—¶é—´: < 1ç§’\n` +
                    `- å½“å‰è®°å½•æ•°: ${data || 0} æ¡`
                );

            } catch (error) {
                setStatus('connectionStatus', 'error', 'âŒ å¤±è´¥');
                setResult('connectionResult', 'error', 
                    `æ•°æ®åº“è¿æ¥å¤±è´¥ï¼š\n${error.message}\n\n` +
                    `å¯èƒ½çš„åŸå› ï¼š\n` +
                    `1. ç½‘ç»œè¿æ¥é—®é¢˜\n` +
                    `2. Supabase é¡¹ç›®æœªå¯åŠ¨\n` +
                    `3. URL æˆ–å¯†é’¥é”™è¯¯\n` +
                    `4. é˜²ç«å¢™é˜»æ­¢è¿æ¥`
                );
            }

            updateProgress();
        }

        async function testTableStructure() {
            if (document.getElementById('connectionStatus').textContent !== 'âœ… é€šè¿‡') {
                setResult('tableResult', 'error', 'è·³è¿‡æµ‹è¯•ï¼šæ•°æ®åº“è¿æ¥æœªé€šè¿‡');
                updateProgress();
                return;
            }

            setStatus('tableStatus', 'pending', 'éªŒè¯ä¸­...');
            setResult('tableResult', 'info', 'æ­£åœ¨éªŒè¯æ•°æ®è¡¨ç»“æ„...');

            try {
                // å°è¯•æŸ¥è¯¢è¡¨ç»“æ„
                const { data, error } = await supabase
                    .from('game_feedback')
                    .select('*')
                    .limit(1);

                if (error) {
                    throw error;
                }

                // æ£€æŸ¥å¿…è¦çš„åˆ—æ˜¯å¦å­˜åœ¨ï¼ˆé€šè¿‡æ’å…¥æµ‹è¯•æ•°æ®æ¥éªŒè¯ï¼‰
                const testData = {
                    player_name: 'structure_test',
                    suggestions: 'test',
                    score: 0,
                    accuracy: 0,
                    play_time: 0,
                    current_level: 1,
                    max_levels: 1
                };

                const { error: insertError } = await supabase
                    .from('game_feedback')
                    .insert(testData)
                    .select();

                if (insertError) {
                    throw new Error(`è¡¨ç»“æ„éªŒè¯å¤±è´¥: ${insertError.message}`);
                }

                // åˆ é™¤æµ‹è¯•æ•°æ®
                await supabase
                    .from('game_feedback')
                    .delete()
                    .eq('player_name', 'structure_test');

                setStatus('tableStatus', 'success', 'âœ… é€šè¿‡');
                setResult('tableResult', 'success', 
                    `æ•°æ®è¡¨ç»“æ„éªŒè¯é€šè¿‡ï¼\n` +
                    `- è¡¨å: game_feedback\n` +
                    `- å¿…è¦å­—æ®µ: å…¨éƒ¨å­˜åœ¨\n` +
                    `- çº¦æŸæ¡ä»¶: æ­£å¸¸\n` +
                    `- RLS ç­–ç•¥: å·²å¯ç”¨`
                );

            } catch (error) {
                setStatus('tableStatus', 'error', 'âŒ å¤±è´¥');
                setResult('tableResult', 'error', 
                    `æ•°æ®è¡¨ç»“æ„éªŒè¯å¤±è´¥ï¼š\n${error.message}\n\n` +
                    `è¯·ç¡®ä¿ï¼š\n` +
                    `1. å·²æ‰§è¡Œ SQL è„šæœ¬åˆ›å»ºè¡¨\n` +
                    `2. è¡¨åä¸º game_feedback\n` +
                    `3. åŒ…å«æ‰€æœ‰å¿…è¦å­—æ®µ\n` +
                    `4. RLS ç­–ç•¥é…ç½®æ­£ç¡®`
                );
            }

            updateProgress();
        }

        async function prepareInsertTest() {
            if (document.getElementById('tableStatus').textContent !== 'âœ… é€šè¿‡') {
                setResult('insertResult', 'error', 'è·³è¿‡æµ‹è¯•ï¼šæ•°æ®è¡¨ç»“æ„éªŒè¯æœªé€šè¿‡');
                updateProgress();
                return;
            }

            setStatus('insertStatus', 'pending', 'å‡†å¤‡ä¸­...');
            setResult('insertResult', 'info', 'æ•°æ®æ’å…¥æµ‹è¯•å·²å‡†å¤‡å°±ç»ªï¼Œè¯·å¡«å†™æµ‹è¯•æ•°æ®å¹¶ç‚¹å‡»æµ‹è¯•æŒ‰é’®ã€‚');
            document.getElementById('testForm').style.display = 'block';
            updateProgress();
        }

        async function testDataInsert() {
            setStatus('insertStatus', 'pending', 'æ’å…¥ä¸­...');
            setResult('insertResult', 'info', 'æ­£åœ¨æµ‹è¯•æ•°æ®æ’å…¥...');

            try {
                const testData = {
                    player_name: document.getElementById('testPlayerName').value || 'æµ‹è¯•ç”¨æˆ·',
                    suggestions: document.getElementById('testSuggestions').value || 'æµ‹è¯•åé¦ˆ',
                    score: parseInt(document.getElementById('testScore').value) || 100,
                    accuracy: 95.5,
                    play_time: 300,
                    current_level: 5,
                    max_levels: 10,
                    user_agent: navigator.userAgent,
                    screen_resolution: `${screen.width}x${screen.height}`
                };

                const { data, error } = await supabase
                    .from('game_feedback')
                    .insert(testData)
                    .select();

                if (error) {
                    throw error;
                }

                setStatus('insertStatus', 'success', 'âœ… é€šè¿‡');
                setResult('insertResult', 'success', 
                    `æ•°æ®æ’å…¥æµ‹è¯•æˆåŠŸï¼\n` +
                    `- æ’å…¥è®°å½• ID: ${data[0].id}\n` +
                    `- ç©å®¶åç§°: ${data[0].player_name}\n` +
                    `- åˆ›å»ºæ—¶é—´: ${new Date(data[0].created_at).toLocaleString('zh-CN')}\n` +
                    `- æ‰€æœ‰åŠŸèƒ½: æ­£å¸¸å·¥ä½œ\n\n` +
                    `ğŸ‰ æ­å–œï¼Supabase é…ç½®å®Œå…¨æ­£ç¡®ï¼Œæ¸¸æˆå¯ä»¥æ­£å¸¸æ”¶é›†ç”¨æˆ·åé¦ˆäº†ï¼`
                );

            } catch (error) {
                setStatus('insertStatus', 'error', 'âŒ å¤±è´¥');
                setResult('insertResult', 'error', 
                    `æ•°æ®æ’å…¥æµ‹è¯•å¤±è´¥ï¼š\n${error.message}\n\n` +
                    `å¯èƒ½çš„åŸå› ï¼š\n` +
                    `1. RLS ç­–ç•¥é…ç½®é”™è¯¯\n` +
                    `2. å­—æ®µçº¦æŸä¸æ»¡è¶³\n` +
                    `3. æƒé™è®¾ç½®é—®é¢˜\n` +
                    `4. æ•°æ®æ ¼å¼é”™è¯¯`
                );
            }
        }

        function resetTest() {
            testProgress = 0;
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('testForm').style.display = 'none';
            
            // é‡ç½®æ‰€æœ‰çŠ¶æ€
            ['configStatus', 'connectionStatus', 'tableStatus', 'insertStatus'].forEach(id => {
                setStatus(id, 'pending', 'ç­‰å¾…æµ‹è¯•');
            });

            // é‡ç½®æ‰€æœ‰ç»“æœ
            setResult('configResult', 'info', 'ç‚¹å‡»"å¼€å§‹æµ‹è¯•"æŒ‰é’®å¼€å§‹æ£€æŸ¥é…ç½®æ–‡ä»¶...');
            setResult('connectionResult', 'info', 'ç­‰å¾…é…ç½®æ–‡ä»¶æ£€æŸ¥å®Œæˆ...');
            setResult('tableResult', 'info', 'ç­‰å¾…æ•°æ®åº“è¿æ¥æµ‹è¯•å®Œæˆ...');
            setResult('insertResult', 'info', 'ç­‰å¾…æ•°æ®è¡¨ç»“æ„éªŒè¯å®Œæˆ...');

            document.getElementById('startTestBtn').disabled = false;
        }

        // é¡µé¢åŠ è½½æ—¶çš„æç¤º
        window.addEventListener('load', () => {
            console.log('ğŸ§ª Supabase é…ç½®æµ‹è¯•å·¥å…·å·²åŠ è½½');
            
            // æ£€æŸ¥æ˜¯å¦æœ‰é…ç½®æ–‡ä»¶
            if (typeof SUPABASE_CONFIG === 'undefined') {
                setResult('configResult', 'error', 
                    'âš ï¸ æœªæ£€æµ‹åˆ°é…ç½®æ–‡ä»¶ï¼\n\n' +
                    'è¯·å…ˆå®Œæˆä»¥ä¸‹æ­¥éª¤ï¼š\n' +
                    '1. è®¿é—® simple-setup.html å®Œæˆé…ç½®\n' +
                    '2. ç¡®ä¿ js/config.js æ–‡ä»¶å­˜åœ¨\n' +
                    '3. åˆ·æ–°æ­¤é¡µé¢é‡æ–°æµ‹è¯•'
                );
            }
        });
    </script>
</body>
</html>